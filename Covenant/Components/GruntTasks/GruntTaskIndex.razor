@page "/grunttask"
@page "/grunttask/index"
@attribute [Authorize(Roles = "User, Administrator")]
@inherits OwningComponentBase<ICovenantService>
@implements IDisposable

@using System.IO
@using Microsoft.JSInterop

@using YamlDotNet.Serialization

@using Covenant.Core
@using Covenant.Models.Grunts
@using Covenant.Components.Shared
@using Covenant.Components.EmbeddedResources
@using Covenant.Components.ReferenceAssemblies
@using Covenant.Components.ReferenceSourceLibraries
@using Microsoft.AspNetCore.Components.Forms
@inject INotificationService INotificationService
@inject IJSRuntime IJSRuntime


<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3">
    <h1 class="h2">Tasks</h1>
</div>

<ul class="nav nav-tabs mb-3" id="grunt-tab" role="tablist">
    <li class="nav-item">
        <a class="nav-link" id="tasks-tab" data-toggle="tab" href="#tasks" role="tab" aria-controls="tasks" aria-selected="false">Tasks</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="libraries-tab" data-toggle="tab" href="#libraries" role="tab" aria-controls="libraries" aria-selected="false">Reference Source Libraries</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="assemblies-tab" data-toggle="tab" href="#assemblies" role="tab" aria-controls="assemblies" aria-selected="false">Reference Assemblies</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="resources-tab" data-toggle="tab" href="#resources" role="tab" aria-controls="resources" aria-selected="false">Embedded Resources</a>
    </li>
</ul>

<div class="tab-content" id="grunt-tab-content">
    <div class="tab-pane fade" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
        <GruntTaskTable GruntTasks="GruntTasks" />
        <a href="/grunttask/create" class="btn btn-primary">
            <span class="fe fe-plus"></span>
            Create
        </a>
        <ButtonActivatedModal @ref="_ImportModal" class="btn btn-secondary">
            <ButtonContent>
                <span class="fe fe-download"></span>
                Import
            </ButtonContent>
            <TitleContent>Import GruntTask(s)</TitleContent>
            <ModalBody>
                <InputFile OnChange="OnUploadImport"></InputFile>
                @if (string.IsNullOrEmpty(this.ErrorMessage))
                {
                    <span class="text-danger">@ErrorMessage</span>
                }
            </ModalBody>
            <ModalFooter>
                <button type="button" class="btn btn-primary" @onclick="OnImport" data-dismiss="modal">
                    <span class="fe fe-download"></span>
                    Import
                </button>
            </ModalFooter>
        </ButtonActivatedModal>
        <button type="button" class="btn btn-secondary" @onclick="OnExport">
            <span class="fe fe-share"></span>
            Export All
        </button>
    </div>
    <div class="tab-pane fade" id="libraries" role="tabpanel" aria-labelledby="libraries-tab">
        <ReferenceSourceLibraryTable ReferenceSourceLibraries="ReferenceSourceLibraries" />
        <a href="/referencesourcelibrary/create" class="btn btn-primary">
            <span class="fe fe-plus"></span>
            Create
        </a>
    </div>
    <div class="tab-pane fade" id="assemblies" role="tabpanel" aria-labelledby="assemblies-tab">
        <ReferenceAssemblyTable ReferenceAssemblies="ReferenceAssemblies" />
        <a href="/referenceassembly/create" class="btn btn-primary">
            <span class="fe fe-plus"></span>
            Create
        </a>
    </div>
    <div class="tab-pane fade" id="resources" role="tabpanel" aria-labelledby="resources-tab">
        <EmbeddedResourceTable EmbeddedResources="EmbeddedResources" />
        <a href="/embeddedresource/create" class="btn btn-primary">
            <span class="fe fe-plus"></span>
            Create
        </a>
    </div>
</div>

@code {
    [Parameter]
    public IList<GruntTask> GruntTasks { get; set; }

    [Parameter]
    public IList<ReferenceSourceLibrary> ReferenceSourceLibraries { get; set; }

    [Parameter]
    public IList<ReferenceAssembly> ReferenceAssemblies { get; set; }

    [Parameter]
    public IList<EmbeddedResource> EmbeddedResources { get; set; }

    private ButtonActivatedModal _ImportModal;

    protected override async Task OnInitializedAsync()
    {
        this.GruntTasks = this.GruntTasks ?? (await Service.GetGruntTasks()).ToList();
        this.ReferenceSourceLibraries = this.ReferenceSourceLibraries ?? (await Service.GetReferenceSourceLibraries()).ToList();
        this.ReferenceAssemblies = this.ReferenceAssemblies ?? (await Service.GetReferenceAssemblies()).ToList();
        this.EmbeddedResources = this.EmbeddedResources ?? (await Service.GetEmbeddedResources()).ToList();
        this.INotificationService.OnCreateGruntTask += OnCreateGruntTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await IJSRuntime.InvokeAsync<string>("ShowTab", "#tasks-tab");
        }
    }

    public void Dispose()
    {
        INotificationService.OnCreateGruntTask -= OnCreateGruntTask;
    }

    private void OnCreateGruntTask(object sender, GruntTask task)
    {
        GruntTasks.Add(task);
        InvokeAsync(() => StateHasChanged());
    }

    private string ErrorMessage { get; set; }
    private List<GruntTask> ImportedTasks { get; set; } = null;
    private async Task OnUploadImport(InputFileChangeEventArgs args)
    {
        try
        {
            var file = args.File;
            using var ms = new MemoryStream();
            await using var stream = file.OpenReadStream();
            await stream.CopyToAsync(ms);
            var yaml = Common.CovenantEncoding.GetString(ms.ToArray());
            var deserializer = new DeserializerBuilder().Build();
            var serialized = deserializer.Deserialize<List<SerializedGruntTask>>(yaml);
            ImportedTasks = serialized.Select(s => new GruntTask().FromSerializedGruntTask(s)).ToList();
        }
        catch (Exception e)
        {
            ErrorMessage = e.Message;
            StateHasChanged();
        }
    }

    private async Task OnImport()
    {
        if (ImportedTasks != null)
        {
            ErrorMessage = "";
            foreach (var importedTask in ImportedTasks)
            {
                try
                {
                    await Service.CreateGruntTask(importedTask);
                }
                catch (Exception e)
                {
                    ErrorMessage += e.Message + Environment.NewLine;
                    StateHasChanged();
                }
            }
            ImportedTasks = null;
            await _ImportModal.DismissModal();
        }
    }

    private async Task OnExport()
    {
        try
        {
            var tasks = GruntTasks.Select(gruntTask => gruntTask.ToSerializedGruntTask()).ToList();
            var serializer = new SerializerBuilder().Build();
            var yaml = serializer.Serialize(tasks);
            await IJSRuntime.InvokeAsync<string>("DownloadFile", "GruntTasks.yaml", "application/x-yaml", Convert.ToBase64String(Common.CovenantEncoding.GetBytes(yaml)));
        }
        catch (Exception)
        {
            //
        }
    }
}
